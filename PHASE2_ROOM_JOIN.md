# Phase 2: ルーム参加機能 - 実装完了

## 実装内容

### 1. ルーム参加画面の実装

[`app/app/(tabs)/join-room.tsx`](<app/app/(tabs)/join-room.tsx>) を実装しました。

#### 主な機能

- **ルームコード入力**: 4 桁の英数字を入力
- **入力バリデーション**:
  - 空欄チェック
  - 4 桁の英数字形式チェック
  - 自動大文字変換
- **参加処理**: [`joinRoom()`](app/lib/roomApi.ts:142) API を使用
- **エラーハンドリング**: 適切なエラーメッセージ表示
- **ローディング状態**: 処理中の UI 表示

#### UI 要素

- ルームコード入力フィールド（中央揃え、大文字、レタースペーシング）
- 参加ボタン（ローディングインジケーター付き）
- ヒントボックス（使い方の説明）
- キーボード対応（KeyboardAvoidingView）

### 2. 既存の API 活用

[`app/lib/roomApi.ts`](app/lib/roomApi.ts) の以下の関数を使用：

- [`joinRoom(roomCode)`](app/lib/roomApi.ts:142): ルーム参加処理
  - ユーザー認証チェック
  - ルームコードでルーム検索
  - ルームステータス確認（終了済みチェック）
  - プレイヤー状態の初期化
  - プロファイルの更新

## 動作確認手順

### 前提条件

1. Supabase プロジェクトが設定済み
2. アプリが起動している（`npm start`）
3. 匿名ログイン済み

### テスト手順

#### ステップ 1: ルーム作成（ホスト側）

1. **「部屋を作る」タブ**に移動
2. ゲームテンプレートを選択（例: 麻雀）
3. **「部屋を作成」**ボタンをタップ
4. 表示された**ルームコード**（例: `AB23`）をメモ

#### ステップ 2: ルーム参加（ゲスト側）

1. **「部屋に入る」タブ**に移動
2. ルームコード入力欄に、ステップ 1 でメモしたコードを入力
   - 例: `AB23` または `ab23`（大文字・小文字は自動変換）
3. **「参加する」**ボタンをタップ
4. 成功メッセージが表示されることを確認

#### ステップ 3: エラーケースのテスト

##### 3-1. 空欄エラー

- ルームコードを入力せずに「参加する」をタップ
- **期待結果**: 「ルームコードを入力してください」エラー

##### 3-2. 形式エラー

- 不正な形式を入力（例: `123`, `ABCDE`, `AB-23`）
- **期待結果**: 「ルームコードは 4 桁の英数字で入力してください」エラー

##### 3-3. 存在しないルーム

- 存在しないルームコードを入力（例: `ZZZZZZ`）
- **期待結果**: 「ルームが見つかりません」エラー

##### 3-4. 終了済みルーム

1. Supabase ダッシュボードで既存ルームの status を`finished`に変更
2. そのルームコードで参加を試みる

- **期待結果**: 「このルームは既に終了しています」エラー

#### ステップ 4: データベース確認

Supabase ダッシュボードで以下を確認：

1. **profiles テーブル**

   - 参加したユーザーの`current_room_id`が更新されている

2. **rooms テーブル**
   - `current_state`に新しいプレイヤーが追加されている
   - プレイヤー ID をキーとして、初期値が設定されている
   ```json
   {
     "user-id-1": {
       "score": 25000,
       "rank": 0
     },
     "user-id-2": {
       "score": 25000,
       "rank": 0
     }
   }
   ```

### 複数デバイスでのテスト

#### 方法 1: 同じデバイスで複数アカウント

1. アプリを起動してログイン（ユーザー A）
2. ルームを作成してコードをメモ
3. サインアウト
4. 再度ログイン（新しい匿名ユーザー B）
5. メモしたコードでルームに参加

#### 方法 2: 実機とエミュレータ

1. 実機でルームを作成
2. エミュレータで同じルームに参加

#### 方法 3: Expo Go で複数デバイス

1. デバイス A でルームを作成
2. デバイス B で同じ QR コードをスキャンしてアプリを起動
3. デバイス B でルームに参加

## 実装されたファイル

### 新規作成

- なし（既存ファイルを更新）

### 更新

- [`app/app/(tabs)/join-room.tsx`](<app/app/(tabs)/join-room.tsx>) - ルーム参加画面の完全実装

### 使用した既存ファイル

- [`app/lib/roomApi.ts`](app/lib/roomApi.ts) - ルーム参加 API
- [`app/types/index.ts`](app/types/index.ts) - 型定義
- [`app/contexts/AuthContext.tsx`](app/contexts/AuthContext.tsx) - 認証コンテキスト

## 技術的な詳細

### 入力処理

```typescript
// 自動大文字変換とバリデーション
const cleanCode = roomCode.trim().toUpperCase();
if (!/^[A-Z0-9]{4}$/.test(cleanCode)) {
  Alert.alert("エラー", "ルームコードは4桁の英数字で入力してください");
  return;
}
```

### API 呼び出し

```typescript
const { room, error } = await joinRoom(cleanCode);

if (error) {
  Alert.alert("参加失敗", error.message);
  return;
}
```

### ローディング状態管理

```typescript
const [loading, setLoading] = useState(false);

// ボタンの無効化とインジケーター表示
<TouchableOpacity
  style={[styles.button, loading && styles.buttonDisabled]}
  disabled={loading}
>
  {loading ? (
    <ActivityIndicator color="#ffffff" />
  ) : (
    <Text style={styles.buttonText}>参加する</Text>
  )}
</TouchableOpacity>;
```

## Phase 2 の残りのタスク

- [x] ルーム作成機能の実装
- [x] ルーム参加機能の実装
- [ ] Realtime 購読の実装
- [ ] ゲーム画面への遷移

## 次のステップ

### Realtime 購読とゲーム画面の実装

- [ ] ゲーム画面のルーティング設定
- [ ] プレイヤー一覧表示
- [ ] リアルタイム同期（Supabase Realtime）
- [ ] スコア更新機能
- [ ] アクション実行機能

### 今後の改善案

- [ ] ルームコードの QR コード読み取り機能
- [ ] 最近参加したルームの履歴表示
- [ ] ルーム情報のプレビュー（参加前）
- [ ] 再参加機能（切断時の自動復帰）

## トラブルシューティング

### 問題: 「ユーザーが認証されていません」エラー

**解決策**:

- ログイン状態を確認
- 必要に応じて再ログイン

### 問題: 「ルームが見つかりません」エラー

**解決策**:

- ルームコードのスペルを確認
- ルームが削除されていないか確認
- ホストがルームを作成済みか確認

### 問題: データベースに反映されない

**解決策**:

- Supabase の接続状態を確認
- RLS ポリシーが正しく設定されているか確認
- ネットワーク接続を確認

## まとめ

✅ ルーム参加機能が完全に実装されました
✅ 入力バリデーションとエラーハンドリングが実装されました
✅ ユーザーフレンドリーな UI が実装されました
✅ 既存の API を活用して効率的に実装されました

次は、実際にゲームをプレイするための**ゲーム画面**の実装に進みます！
