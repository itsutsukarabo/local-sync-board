# Phase 3.6: バグ修正 & 安定性・UX改善

**作成日:** 2026-02-06
**ステータス:** 計画中
**前提:** Phase 3.5（テンプレートカスタマイズ機能）完了済み

---

## 概要

Phase 3.5で実装したゲーム機能の安定性向上と、実運用で発見されたバグの修正、およびUX改善を行う。
主にリアルタイム同期の信頼性、接続管理、ナビゲーション安全性、プレイヤー管理の改善が対象。

---

## 要件一覧

| # | カテゴリ | 要件 | 詳細 |
|---|----------|------|------|
| ① | バグ修正 | ホスト側リアルタイム反映不具合 | ホスト側で変数追加や他プレイヤー操作がゲーム画面に即反映されない（ホストが操作すると反映される） |
| ② | バグ修正 | ExpoGo起動時ハング | ExpoGoを最初に立ち上げる時スピナーが回り続け起動しない |
| ③ | バグ修正 | 初回着席のローカル反映不具合 | 部屋作成後の初回着席がローカル状態に反映されず、再着席でエラーになる |
| ④ | UX改善 | 戻るボタン確認モーダル | 戻る時に離席確認モーダルを表示し、離席してから画面遷移する |
| ⑤ | UX改善 | スワイプ戻り防止 | ゲーム画面で左スワイプによる戻りを無効化 |
| ⑥ | 安定性 | アプリ復帰時の再接続 | バックグラウンドから復帰した時にリアルタイムチャンネルを再接続する |
| ⑦ | 安定性 | 定期接続確認 & 強制離席 | N秒おきに接続確認し、10分間接続できなければ自動的に離席させる |
| ⑧ | 仕様変更 | ログ復元時の着席状態保持 | ログ復元（rollback/undo）時、変数値は戻すが着席状況は現在の状態を維持する |
| ⑨ | 新機能 | 直近12時間の部屋に再入室 | ホスト・プレイヤー共に直近12時間以内に参加した部屋に再入室できる |
| ⑩ | 新機能 | プレイヤーID再作成 | 匿名IDを作り直す機能（プロフィールリセット） |
| ⑪ | UI改善 | プレイヤーカードに名前表示 | IDの先頭4文字ではなくdisplay_nameを表示する |
| ⑫ | 仕様変更 | Potから全変数一括回収 | Pot回収時に全変数を一括で回収する（現行仕様の明確化・修正） |

---

## タスク分割

### Task 3.6-1: ホスト側リアルタイム反映不具合の修正

**カテゴリ:** バグ修正
**優先度:** 最高

**現状の問題:**
- `useRoomRealtime.ts`のRealtimeサブスクリプションはUPDATEイベントを受信しているはず
- しかしホスト側では他者の操作やテンプレート変更がゲーム画面に反映されない
- ホスト自身が何か操作（transferScore等）すると、その操作後の`refetch()`で初めて最新状態が反映される

**推定原因:**
- Realtimeイベントの`payload.new`から取得したデータが正しくRoom型に変換されていない可能性
- `current_state`がJSON型であり、Realtimeイベントで差分のみ送られる場合のパース問題
- ホスト側で独自にローカル状態を保持しており、Realtimeの更新で上書きされていない可能性
- Supabaseのrealtime channelフィルタ設定の問題

**対象ファイル:**
- `app/hooks/useRoomRealtime.ts`
- `app/app/game/[id].tsx`

**作業内容:**
1. `useRoomRealtime.ts`のUPDATEイベントハンドラをデバッグし、ペイロードの内容を確認
2. Room stateの更新ロジックを確認・修正
3. ホスト・プレイヤー間で同一のリアルタイム更新パスが使われていることを検証
4. 必要に応じてチャンネルフィルタやイベントハンドリングを修正

**完了条件:**
- [ ] ホスト画面で他プレイヤーのスコア操作がリアルタイム反映される
- [ ] ホスト側で変数追加後、操作なしでゲーム画面に反映される
- [ ] プレイヤー側の既存リアルタイム反映に影響がない

---

### Task 3.6-2: ExpoGo起動時ハング問題の修正

**カテゴリ:** バグ修正
**優先度:** 最高

**現状の問題:**
- ExpoGoを初回起動すると、スピナーが回り続けてアプリが起動しない

**推定原因:**
- `AuthContext.tsx`の`useEffect`内でSupabase `getSession()`が解決しない
- ネットワーク未接続状態でのタイムアウト処理がない
- `AuthGuard`のリダイレクトループ（profileのロード完了前にリダイレクトが発火）

**対象ファイル:**
- `app/contexts/AuthContext.tsx`
- `app/app/_layout.tsx`（AuthGuard）

**作業内容:**
1. `AuthContext`のセッション復元ロジックにタイムアウト処理を追加
2. ローディング状態の管理を見直し、セッション確認完了までスプラッシュ画面を表示
3. エラーケース（ネットワーク未接続等）のフォールバック処理を追加
4. `AuthGuard`のリダイレクト条件を`loading`状態考慮に修正

**完了条件:**
- [ ] ExpoGoの初回起動時にスピナーで止まらない
- [ ] オフライン時でもクラッシュせずエラー表示される
- [ ] セッション復元後に正しい画面に遷移する

---

### Task 3.6-3: 初回着席ローカル反映不具合の修正

**カテゴリ:** バグ修正
**優先度:** 高

**現状の問題:**
- 部屋を新規作成し、最初に着席した時だけローカル状態に反映されない
- 再度着席しようとすると「既に着席しています」等のエラーになる
- Supabase上はseatが正しく更新されているが、ローカルのroom stateが古いまま

**推定原因:**
- `joinSeat()`がSupabaseを更新した後、Realtimeイベントの配信前に画面が状態を読む
- 初回の部屋作成直後はRealtimeサブスクリプションがまだ確立されていない可能性
- `joinSeat()`のレスポンスをローカル状態に即反映していないため、Realtime到着までラグがある

**対象ファイル:**
- `app/lib/roomApi.ts`（`joinSeat`関数）
- `app/hooks/useRoomRealtime.ts`
- `app/app/game/[id].tsx`

**作業内容:**
1. `joinSeat()`成功後に明示的に`refetch()`を呼んでローカル状態を更新
2. Realtimeサブスクリプションの確立タイミングを確認
3. 着席処理にoptimistic updateを導入するか、確実にrefetchする仕組みを追加

**完了条件:**
- [ ] 新規部屋作成後の初回着席がローカルに即反映される
- [ ] 2回目以降の着席操作もエラーなく動作する
- [ ] Realtime未到達でもUI上は着席状態が表示される

---

### Task 3.6-4: 戻るボタン確認モーダル

**カテゴリ:** UX改善
**優先度:** 中

**対象ファイル:**
- `app/app/game/[id].tsx`
- 新規: `app/components/game/LeaveConfirmModal.tsx`

**作業内容:**
1. 離席確認モーダルコンポーネントを作成
2. ヘッダーの戻るボタンに確認処理をフック
3. Androidのハードウェアバックボタンにも対応（`BackHandler`）
4. 確認後に`leaveSeat()` → `router.back()`を順次実行

**UI設計:**
```
┌─────────────────────────────────┐
│      部屋を離れますか？          │
├─────────────────────────────────┤
│                                 │
│  離席して部屋を出ます。          │
│  データは保持されます。          │
│                                 │
│  [キャンセル]   [離席して戻る]   │
└─────────────────────────────────┘
```

**完了条件:**
- [ ] 戻るボタンで確認モーダルが表示される
- [ ] 「離席して戻る」で`leaveSeat()`実行後にホーム画面に遷移する
- [ ] 「キャンセル」でゲーム画面に留まる
- [ ] Androidバックボタンでも同じ動作

---

### Task 3.6-5: ゲーム画面スワイプ戻り防止

**カテゴリ:** UX改善
**優先度:** 中

**対象ファイル:**
- `app/app/game/[id].tsx`
- `app/app/game/_layout.tsx`（必要に応じて作成）

**作業内容:**
1. Expo Routerの`screenOptions`で`gestureEnabled: false`を設定
2. ゲーム画面のStack設定でスワイプジェスチャーを無効化
3. 戻る操作は明示的な戻るボタンのみに限定

**実装例:**
```typescript
// Stack.Screen options
<Stack.Screen
  name="game/[id]"
  options={{ gestureEnabled: false }}
/>
```

**完了条件:**
- [ ] ゲーム画面で左スワイプしても前の画面に戻らない
- [ ] 戻るボタンは正常に動作する（Task 3.6-4のモーダル経由）

---

### Task 3.6-6: アプリ復帰時の再接続機能

**カテゴリ:** 安定性
**優先度:** 高

**対象ファイル:**
- `app/hooks/useRoomRealtime.ts`
- 新規: `app/hooks/useAppStateReconnect.ts`

**作業内容:**
1. React Nativeの`AppState` APIを使い、バックグラウンド→フォアグラウンド復帰を検知
2. 復帰時にSupabase Realtimeチャンネルを再接続
3. 復帰時に`refetch()`で最新の部屋データを取得
4. 長時間バックグラウンドだった場合はチャンネルをremove→再subscribeする

**実装方針:**
```typescript
// useAppStateReconnect.ts
import { AppState } from "react-native";

export function useAppStateReconnect(
  onReconnect: () => void
) {
  const appState = useRef(AppState.currentState);

  useEffect(() => {
    const sub = AppState.addEventListener("change", (nextState) => {
      if (appState.current.match(/inactive|background/) && nextState === "active") {
        onReconnect();
      }
      appState.current = nextState;
    });
    return () => sub.remove();
  }, [onReconnect]);
}
```

**完了条件:**
- [ ] アプリをバックグラウンドに送り、戻った時に最新状態が反映される
- [ ] Realtimeサブスクリプションが正しく再確立される
- [ ] 長時間バックグラウンド後も復帰できる

---

### Task 3.6-7: 定期接続確認 & 10分タイムアウト強制離席

**カテゴリ:** 安定性
**優先度:** 高

**対象ファイル:**
- 新規: `app/hooks/useConnectionMonitor.ts`
- `app/lib/roomApi.ts`（ハートビート機能追加）
- `app/hooks/useRoomRealtime.ts`

**作業内容:**
1. ハートビートの仕組みを実装（N秒おきに接続確認）
2. 接続状態をUIに表示（接続中/切断中）
3. 10分間接続できない場合、自動的に`leaveSeat()`を呼び離席処理する
4. サーバーサイド（Supabase）で最終接続時刻を管理

**ハートビート設計:**
```typescript
// 方法A: Supabase presence を使用
channel.track({ user_id: userId, online_at: new Date().toISOString() });

// 方法B: profilesテーブルのlast_seen_atを定期更新
// N秒おきに profiles.last_seen_at = now() を更新
// 他クライアントが last_seen_at を見て10分超過していれば離席
```

**seats.statusの活用:**
- `"active"`: 接続中
- `"inactive"`: 切断中（復帰待ち）
- 10分経過 → seatをnullに設定（強制離席）

**UI表示:**
- プレイヤーカードに接続状態インジケータを追加
- `inactive`のプレイヤーカードをグレーアウト表示

**完了条件:**
- [ ] N秒ごとにハートビートが送信される
- [ ] 切断時にUIが切断状態を表示する
- [ ] 10分間接続できないプレイヤーが自動離席される
- [ ] 復帰時に再着席できる

---

### Task 3.6-8: ログ復元時の着席状態保持

**カテゴリ:** 仕様変更
**優先度:** 中

**現状の問題:**
- `rollbackTo()`や`undoLast()`でスナップショットを復元すると、着席状態（seats）も巻き戻ってしまう可能性がある
- 離席済みのプレイヤーの変数値は復元するが、着席状態は現在のまま維持すべき

**対象ファイル:**
- `app/lib/roomApi.ts`（`rollbackTo`、`undoLast`関数）

**作業内容:**
1. `rollbackTo()`でsnapshotを復元する際、`seats`は現在の状態を維持するように修正
2. `undoLast()`も同様に修正
3. 復元対象は`current_state`のプレイヤー変数と`__pot__`のみとし、`__history__`とseatsは除外
4. 離席済みプレイヤーの変数値もスナップショット通りに復元する

**完了条件:**
- [ ] ログ復元後もseatsの状態が変わらない
- [ ] 離席済みプレイヤーの変数値はスナップショット通りに復元される
- [ ] 復元後もゲームを正常に続行できる

---

### Task 3.6-9: 直近12時間の部屋に再入室機能

**カテゴリ:** 新機能
**優先度:** 中

**対象ファイル:**
- `app/app/(tabs)/index.tsx`（ホーム画面）
- `app/lib/roomApi.ts`（最近の部屋取得API追加）
- `app/types/index.ts`（必要に応じて型追加）
- 新規: `app/components/home/RecentRooms.tsx`

**作業内容:**
1. 部屋参加時に参加履歴をローカル（AsyncStorage）またはprofilesテーブルに保存
2. ホーム画面に「最近の部屋」セクションを追加
3. 12時間以内に参加した部屋を一覧表示
4. タップで再入室（部屋が存在し、status="active"の場合のみ）
5. ホスト・プレイヤー共に利用可能

**データ保存:**
```typescript
// AsyncStorageに保存する形式
interface RecentRoom {
  roomId: string;
  roomCode: string;
  joinedAt: number;     // Unix timestamp
  isHost: boolean;
  templateName: string; // 表示用
}
// キー: "recent_rooms"
// 値: RecentRoom[] (最大20件、12時間以上経過分は表示時にフィルタ)
```

**UI設計:**
```
┌─────────────────────────────────┐
│ 最近の部屋                      │
├─────────────────────────────────┤
│ 🏠 ABCD (ホスト) - 30分前      │
│ 👤 EFGH (プレイヤー) - 2時間前  │
├─────────────────────────────────┤
│                                 │
│  [部屋を作る]  [部屋に入る]     │
└─────────────────────────────────┘
```

**完了条件:**
- [ ] 部屋参加時に履歴がローカルに保存される
- [ ] ホーム画面に最近の部屋一覧が表示される
- [ ] タップで部屋に再入室できる
- [ ] 12時間以上前の部屋は表示されない
- [ ] 存在しない部屋や終了した部屋はエラー表示される

---

### Task 3.6-10: プレイヤーネーム変更機能

**カテゴリ:** 新機能
**優先度:** 低

**現状:**
- `welcome.tsx` に「ニックネームは後から変更できます」と記載されているが、変更機能が未実装

**対象ファイル:**
- `app/app/(tabs)/index.tsx`（ホーム画面にプロフィール表示追加）
- 新規: `app/components/home/EditNameModal.tsx`（名前編集モーダル）

**作業内容:**
1. ホーム画面のタイトル下に現在のユーザー名を表示
2. ユーザー名タップで編集モーダルを開く
3. 編集モーダルで名前を変更して保存（`updateProfile`使用）
4. バリデーションは`welcome.tsx`と同じ（2〜20文字）

**UI設計:**

ホーム画面:
```
┌─────────────────────────────────┐
│      Local Sync Board           │
│   リアルタイム共有ボードアプリ    │
│                                 │
│      👤 プレイヤー名 ✏️          │  ← タップで編集
│                                 │
│      [  部屋を作る  ]           │
│      [  部屋に入る  ]           │
└─────────────────────────────────┘
```

編集モーダル:
```
┌─────────────────────────────────┐
│      ニックネーム変更            │
├─────────────────────────────────┤
│  [現在の名前が入力された状態]    │
│  2〜20文字で入力してください     │
│                                 │
│  [キャンセル]      [保存]       │
└─────────────────────────────────┘
```

**完了条件:**
- [ ] ホーム画面に現在のユーザー名が表示される
- [ ] タップで編集モーダルが開く
- [ ] 名前を変更して保存できる
- [ ] バリデーション（2〜20文字）が機能する
- [ ] 保存後、表示が即座に更新される

---

### Task 3.6-11: プレイヤーカードに名前表示

**カテゴリ:** UI改善
**優先度:** 高

**現状の問題:**
- `MahjongPlayerCard.tsx`で自分以外のプレイヤーは`Player {playerId.slice(0, 4)}`と表示
- UUID先頭4文字は意味がなく、誰が誰かわからない

**対象ファイル:**
- `app/components/game/MahjongPlayerCard.tsx`
- `app/components/game/PlayerCard.tsx`
- `app/app/game/[id].tsx`（プレイヤー名のデータ取得）
- `app/lib/roomApi.ts`（プレイヤー名取得API）

**作業内容:**
1. 着席時にプレイヤーのdisplay_nameをroom stateに保存する（または都度profilesから取得）
2. `MahjongPlayerCard`の表示ロジックを修正
3. 自分のカードは「あなた」、他プレイヤーはdisplay_nameを表示
4. display_nameが未設定の場合のフォールバック表示を用意

**実装方針:**
- 方法A: `joinSeat()`時にseats配列に`displayName`を追加保存（リアルタイム同期される）
- 方法B: 別途`playerNames`マップをroom stateに持つ
- 方法Aが効率的（seatsは既にリアルタイム同期されている）

**SeatInfo型の拡張:**
```typescript
interface SeatInfo {
  userId: string | null;
  status: "active" | "inactive";
  displayName?: string;  // 追加
}
```

**完了条件:**
- [ ] プレイヤーカードにdisplay_nameが表示される
- [ ] 自分のカードは「あなた」表示のまま
- [ ] 名前未設定時のフォールバック（例: "Player 1"）がある
- [ ] 履歴ログにもdisplay_nameが表示される

---

### Task 3.6-12: Pot全変数一括回収

**カテゴリ:** 仕様変更
**優先度:** 中

**現状の確認:**
- `MahjongTable.tsx`のhandleDropでPot→Playerの場合、`Object.entries(pot).filter(([, value]) => (value || 0) > 0)`で全変数を取得している
- 既に全変数を回収するロジックになっているが、動作を確認・修正する

**対象ファイル:**
- `app/components/game/MahjongTable.tsx`（handleDrop内のPot回収ロジック）
- `app/lib/roomApi.ts`（transferScore内のPot回収処理）

**作業内容:**
1. Pot回収時に全変数が確実に一括で移動されることを確認
2. 一部の変数のみ回収するロジックがあれば削除
3. 回収後にPotが完全に空になることを確認
4. 回収操作のメッセージを「供託金全額回収」のように明確にする

**完了条件:**
- [ ] Pot回収で全変数が一括で対象プレイヤーに移動する
- [ ] 回収後のPotが全変数0になる
- [ ] 履歴ログに回収内容が正しく記録される

---

## 実装順序

```
【最優先 - バグ修正】
Task 3.6-1: ホスト側リアルタイム反映不具合
Task 3.6-2: ExpoGo起動時ハング
Task 3.6-3: 初回着席ローカル反映不具合
    ↓
【高優先 - 安定性 & 基盤】
Task 3.6-6: アプリ復帰時の再接続
Task 3.6-7: 定期接続確認 & 強制離席
Task 3.6-11: プレイヤーカードに名前表示
    ↓
【中優先 - UX改善 & 仕様変更】
Task 3.6-4: 戻るボタン確認モーダル
Task 3.6-5: スワイプ戻り防止
Task 3.6-8: ログ復元時の着席状態保持
Task 3.6-9: 直近12時間の部屋に再入室
Task 3.6-12: Pot全変数一括回収
    ↓
【低優先】
Task 3.6-10: プレイヤーID再作成機能
    ↓
動作確認・テスト
```

---

## 影響を受けるファイル一覧

| ファイル | 関連タスク | 変更内容 |
|----------|-----------|----------|
| `app/hooks/useRoomRealtime.ts` | 3.6-1, 3.6-6, 3.6-7 | リアルタイム同期修正、再接続、接続監視 |
| `app/contexts/AuthContext.tsx` | 3.6-2, 3.6-10 | 起動時ハング修正、ID再作成 |
| `app/app/_layout.tsx` | 3.6-2 | AuthGuardのローディング制御 |
| `app/lib/roomApi.ts` | 3.6-3, 3.6-7, 3.6-8, 3.6-9, 3.6-11, 3.6-12 | 着席修正、ハートビート、復元、名前取得 |
| `app/app/game/[id].tsx` | 3.6-1, 3.6-3, 3.6-4, 3.6-5 | 画面全般の修正 |
| `app/components/game/MahjongTable.tsx` | 3.6-12 | Pot回収ロジック |
| `app/components/game/MahjongPlayerCard.tsx` | 3.6-11 | 名前表示修正 |
| `app/components/game/PlayerCard.tsx` | 3.6-11 | 名前表示修正 |
| `app/app/(tabs)/index.tsx` | 3.6-9, 3.6-10 | 最近の部屋、ID再作成 |
| `app/types/index.ts` | 3.6-7, 3.6-11 | SeatInfo拡張 |
| 新規: `app/hooks/useAppStateReconnect.ts` | 3.6-6 | 復帰検知フック |
| 新規: `app/hooks/useConnectionMonitor.ts` | 3.6-7 | 接続監視フック |
| 新規: `app/components/game/LeaveConfirmModal.tsx` | 3.6-4 | 離席確認モーダル |
| 新規: `app/components/home/RecentRooms.tsx` | 3.6-9 | 最近の部屋コンポーネント |

---

## テストシナリオ

### シナリオ1: ホストリアルタイム反映
1. ホストが部屋を作成し着席
2. プレイヤーが入室・着席
3. プレイヤーがスコア移動を行う
4. **ホストが何も操作せずにスコア変更がホスト画面に反映されること**

### シナリオ2: 初回着席
1. ホストが部屋を新規作成
2. ゲーム画面に遷移
3. 空席をタップして着席
4. **着席状態が即座にローカルに反映されること**
5. プレイヤーカードに自分が表示されること

### シナリオ3: バックグラウンド復帰
1. ゲーム中にアプリをバックグラウンドに送る
2. 他のプレイヤーがスコア操作を行う
3. アプリをフォアグラウンドに戻す
4. **最新のスコア状態が反映されること**
5. Realtimeサブスクリプションが再確立されること

### シナリオ4: 離席確認
1. ゲーム画面で戻るボタンをタップ
2. **確認モーダルが表示されること**
3. 「離席して戻る」をタップ
4. 離席処理が実行され、ホーム画面に遷移すること

### シナリオ5: 最近の部屋に再入室
1. 部屋に参加してゲームを行い、離席して戻る
2. ホーム画面に「最近の部屋」が表示される
3. タップして再入室
4. 以前の部屋に正しく入室できること

### シナリオ6: プレイヤー名表示
1. 2人以上が着席した状態でゲーム画面を確認
2. 自分のカードは「あなた」と表示
3. **他のプレイヤーのカードにdisplay_nameが表示されること**

### シナリオ7: 接続タイムアウト
1. プレイヤーAが着席中にネットワークを切断
2. 他のプレイヤーの画面でプレイヤーAがグレーアウト表示になる
3. 10分経過後、プレイヤーAが自動離席される
4. プレイヤーAがネットワーク復帰後、再着席できること

---

## 次のステップ

Phase 3.6完了後:
- Phase 4: 精算画面（`finalize_game`権限を使用）
- Phase 5: QRコード機能

---

**最終更新:** 2026-02-06
