# Phase 3: 麻雀モード UI テストガイド

## ⚠️ 重要な注意事項

### 既存のルームについて

**Phase 3 実装前に作成されたルームは、`layoutMode`プロパティを持っていません。**

そのため、既存のルームでは麻雀モード UI は表示されず、デフォルトのリストモードが使用されます。

## 🧪 テスト手順

### ステップ 1: アプリの完全再起動

babel.config.js を変更したため、キャッシュをクリアして再起動が必要です：

```bash
cd app
npx expo start -c
```

### ステップ 2: 新しいルームを作成

1. アプリを起動
2. ニックネームを設定（未設定の場合）
3. **「ルームを作成」タブ**に移動
4. **「麻雀」テンプレート**を選択
5. 「ルームを作成」ボタンをタップ

### ステップ 3: コンソールログを確認

ゲーム画面が表示されたら、コンソールログを確認してください：

```
Game screen - Template: { variables: [...], actions: [...], layoutMode: "mahjong", maxPlayers: 4, potEnabled: true }
Game screen - Layout Mode: mahjong
Game screen - Pot Enabled: true
```

**期待される結果:**

- `Layout Mode: mahjong` と表示される
- 緑色の麻雀卓が表示される（背景色: #10b981）

**もし `Layout Mode: list` と表示される場合:**

- 古いルームを使用している可能性があります
- 新しいルームを作成してください

### ステップ 4: ゲームに参加

1. 「🎮 ゲームに参加」ボタンをタップ
2. 自分のプレイヤーカードが画面下に表示される
3. 中央に黄色い供託金エリアが表示される

### ステップ 5: 他のプレイヤーを追加（オプション）

複数デバイスまたは別のブラウザで：

1. 同じルームコードで参加
2. ゲームに参加
3. プレイヤーカードが 4 方向に配置される

### ステップ 6: ドラッグ＆ドロップのテスト

1. 自分のカード（画面下）を長押し
2. カードが少し大きくなる（scale: 1.1）
3. 中央の供託金エリアにドラッグ
4. ドロップすると 1000 点が即座に移動
5. 供託金エリアに「🎴 1 本」と表示される

## 🐛 トラブルシューティング

### 問題 1: 麻雀モードが表示されない

**原因:** 古いルームを使用している

**解決策:**

1. 「← 戻る」ボタンでホーム画面に戻る
2. 新しいルームを作成
3. 必ず「麻雀」テンプレートを選択

### 問題 2: コンソールに `Layout Mode: list` と表示される

**原因:** テンプレートに `layoutMode` が設定されていない

**確認方法:**

```
Game screen - Template: { variables: [...], actions: [...] }
```

↑ `layoutMode` プロパティがない

**解決策:**

1. [`app/utils/roomUtils.ts`](app/utils/roomUtils.ts:52) を確認
2. `DEFAULT_MAHJONG_TEMPLATE` に `layoutMode: "mahjong"` があることを確認
3. アプリを再起動（`npx expo start -c`）
4. 新しいルームを作成

### 問題 3: ドラッグが動作しない

**原因:** `react-native-gesture-handler` が正しくインストールされていない

**解決策:**

```bash
cd app
npm install react-native-gesture-handler --legacy-peer-deps
npx expo start -c
```

### 問題 4: アニメーションが動作しない

**原因:** `react-native-reanimated` のプラグインが設定されていない

**確認:**
[`app/babel.config.js`](app/babel.config.js:6) に以下があることを確認：

```javascript
plugins: ["react-native-reanimated/plugin"];
```

**解決策:**

```bash
cd app
npx expo start -c
```

## 📊 期待される動作

### リストモード（シンプルスコア）

- スクロール可能なプレイヤーリスト
- 「ゲームに参加」/「ゲームから退出」ボタン
- アクションボタン（+1, +10, -1）
- ホストコントロール

### 麻雀モード（麻雀テンプレート）

- 緑色の麻雀卓（フルスクリーン）
- 4 方向の座席配置
  - 下: 自分（あなた）
  - 上: 対面プレイヤー
  - 左: 上家
  - 右: 下家
- 中央: 黄色い供託金エリア
- ドラッグ可能なプレイヤーカード
- 支払いモーダル

## 🎯 テストシナリオ

### シナリオ 1: リーチ（Pot への支払い）

1. 自分のカードを長押し
2. 中央の供託金エリアにドラッグ＆ドロップ
3. **期待結果:**
   - 自分の点数が 1000 点減少
   - 供託金が 1000 点増加
   - 「🎴 1 本」と表示される
   - 他のデバイスでも即座に反映される

### シナリオ 2: 供託回収（Pot からの取得）

1. 中央の供託金エリアを長押し
2. 自分のカードにドラッグ＆ドロップ
3. **期待結果:**
   - 供託金が 0 になる
   - 自分の点数が供託金分増加
   - リーチ棒カウントが 0 になる

### シナリオ 3: 対人支払い

1. 自分のカードを長押し
2. 他のプレイヤーのカードにドラッグ＆ドロップ
3. **期待結果:**
   - 支払いモーダルが表示される
   - クイック選択ボタン（1000, 2000, 3000, 5000, 8000, 12000）
   - 金額を入力または選択
   - 「支払う」ボタンをタップ
   - 点数が移動

### シナリオ 4: エラーケース

1. 所持金以上の金額を支払おうとする
2. **期待結果:**
   - エラーアラート「点数が不足しています」

## 📝 デバッグ情報の確認

コンソールログで以下を確認してください：

```javascript
// ルーム情報
Game screen - Room: <room-id>
Game screen - Template: { layoutMode: "mahjong", ... }
Game screen - Layout Mode: mahjong
Game screen - Pot Enabled: true

// プレイヤー情報
Game screen - Players: ["user-id-1", "user-id-2"]
Game screen - Player count: 2
Game screen - Current user: <your-user-id>
Game screen - Is user in game: true

// スコア移動
Score transferred successfully
```

## ✅ 完了チェックリスト

- [ ] アプリをキャッシュクリアして再起動した
- [ ] 新しいルームを作成した（麻雀テンプレート）
- [ ] コンソールに `Layout Mode: mahjong` と表示される
- [ ] 緑色の麻雀卓が表示される
- [ ] 自分のカードが画面下に表示される
- [ ] 中央に供託金エリアが表示される
- [ ] ドラッグ＆ドロップが動作する
- [ ] スコア移動がリアルタイムで反映される

---

**作成日:** 2026-01-10
**対象:** Phase 3 実装のテスト
